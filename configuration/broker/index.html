<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.98.0"><meta name=generator content="Relearn 5.8.0"><meta name=description content><meta name=author content="Choria Project"><title>Broker Setup :: Choria Provisioner</title><link href=https://choria-io.github.io/provisioner/configuration/broker/index.xml rel=alternate type=application/rss+xml title="Broker Setup :: Choria Provisioner"><link href=https://choria-io.github.io/provisioner/css/fontawesome-all.min.css?1726062753 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/provisioner/css/fontawesome-all.min.css?1726062753 rel=stylesheet></noscript><link href=https://choria-io.github.io/provisioner/css/featherlight.min.css?1726062753 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/provisioner/css/featherlight.min.css?1726062753 rel=stylesheet></noscript><link href=https://choria-io.github.io/provisioner/css/auto-complete.css?1726062753 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/provisioner/css/auto-complete.css?1726062753 rel=stylesheet></noscript><link href=https://choria-io.github.io/provisioner/css/perfect-scrollbar.min.css?1726062753 rel=stylesheet><link href=https://choria-io.github.io/provisioner/css/nucleus.css?1726062753 rel=stylesheet><link href=https://choria-io.github.io/provisioner/css/fonts.css?1726062753 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/provisioner/css/fonts.css?1726062753 rel=stylesheet></noscript><link href=https://choria-io.github.io/provisioner/css/theme.css?1726062753 rel=stylesheet><link href=https://choria-io.github.io/provisioner/css/theme-choria-relearn.css?1726062753 rel=stylesheet id=variant-style><link href=https://choria-io.github.io/provisioner/css/ie.css?1726062753 rel=stylesheet><link href=https://choria-io.github.io/provisioner/css/variant.css?1726062753 rel=stylesheet><link href=https://choria-io.github.io/provisioner/css/print.css?1726062753 rel=stylesheet media=print><script src=https://choria-io.github.io/provisioner/js/url.js?1726062753></script>
<script src=https://choria-io.github.io/provisioner/js/variant.js?1726062753></script>
<script>window.index_json_url="https://choria-io.github.io/provisioner/index.json";var root_url="https://choria-io.github.io/provisioner/",baseUriFull,baseUri=root_url.replace(/\/$/,'');window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://choria-io.github.io/provisioner/",window.variants&&variants.init(["choria-relearn"])</script><script src=https://choria-io.github.io/provisioner/js/jquery.min.js?1726062753 defer></script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=https://choria-io.github.io/provisioner/configuration/broker/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable dir=ltr><div><div class=navigation><a class="nav nav-next" href=https://choria-io.github.io/provisioner/configuration/helper/index.html title="Writing a Helper (&#129106;)"><i class="fas fa-chevron-right fa-fw"></i></a></div><div class=navigation><a class="nav nav-prev" href=https://choria-io.github.io/provisioner/configuration/server/index.html title="Server Setup (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle title="Menu (CTRL+ALT+n)"><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title="Table of Contents (CTRL+ALT+t)"><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/provisioner/index.html><span itemprop=name>Choria Provisioner</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/provisioner/configuration/index.html><span itemprop=name>Configuration</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Broker Setup</span><meta itemprop=position content="3"></li></ol></div><div class="default-animation progress"><div class=toc-wrapper dir=ltr><nav id=TableOfContents><ul><li><a href=#enabling-the-system-account>Enabling the System Account</a></li><li><a href=#enabling-the-provisioning-account>Enabling the Provisioning Account</a><ul><li><a href=#x509-based-choria>x509 Based Choria</a></li><li><a href=#organization-based-choria>Organization Based Choria</a></li></ul></li><li><a href=#confirming>Confirming</a></li></ul></nav></div></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=broker-setup>Broker Setup</h1><p>Choria Broker supports a concept called an Account or Organization, these are like a VLAN on your network switches.</p><p>Nodes partitioned into one Organization cannot communicate with nodes in any other Organizations unless special arrangements are made to facilitate that.</p><p>We use this feature to create an isolated network where unprovisioned servers wait for provisioning. When Choria Provisioner connects using fully verified credentials it gains access to these isolated Servers and can provision them.</p><p><a href=../../unverified-tls-provisioning.png data-featherlight=image><img src=../../unverified-tls-provisioning.png alt="TLS Based Provisioning" style=height:auto;width:auto loading=lazy></a></p><p>Here we show one Choria Broker Cluster with a Choria Account and a Provisioning Account active. Unverified connections enter the Provisioning Account automatically. The Provisioner connects with its fully verified credentials that identify it as a Provisioner and gains access to the unprovisioned servers.</p><p>Restrictions in the Choria Broker authentication layer ensures this separation is not optional and enforce control over what software gains access to the unprovisioned fleet.</p><h2 id=enabling-the-system-account>Enabling the System Account</h2><p>We suggest enabling the Choria Broker system account to allow introspection of nodes waiting to be provisioned and more.</p><p>Configure this in both your Broker and Client configurations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.system.user</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>system</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.system.password</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>system</span>
</span></span></code></pre></div><h2 id=enabling-the-provisioning-account>Enabling the Provisioning Account</h2><p>The Choria Provisioner will connect using its normal Certificate or JWT token which means it will appear just like any other client. To differentiate it we force it to connect to a specific user and password.</p><p>The password is unique per environment and should be configured in the broker:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.provisioning.client_password</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>provSecret</span>
</span></span></code></pre></div><h3 id=x509-based-choria>x509 Based Choria</h3><p>If you are using an x509 based network you have to set the Public certificate that was used to <a href=../server/>configure servers</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.provisioning.signer_cert</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/choria/provisioning-jwt-signer.pem</span>
</span></span></code></pre></div><h3 id=organization-based-choria>Organization Based Choria</h3><div class="box notices cstyle secondary"><div class=box-label><i class="fa-fw fas fa-code-branch"></i> Version Hint</div><div class=box-content><p>This applies only to Choria 0.27.0 and newer which is due to ship early 2023</p></div></div><p>If you are using an Organization Issuer you should already have the issuer configured and have used that issuer to sign the <code>provisioning.jwt</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.security.issuer.names</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.issuer.choria.public</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>4ada2...cea4</span>
</span></span></code></pre></div><h2 id=confirming>Confirming</h2><p>Once configured you can run the command <code>choria broker server report conns --account provisioning</code> to both confirm the account is active and it will show any connections made to this account. The Choria Provisioner will appear there as well as any machines being provisioned.</p><p><a href=../../prov-account-conns.png data-featherlight=image><img src=../../prov-account-conns.png alt="Provisioning account connections" style=height:auto;width:auto loading=lazy></a></p><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation dir=ltr><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=https://choria-io.github.io/provisioner/logo.png></div><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script>var contentLangs=["en"]</script><script src=https://choria-io.github.io/provisioner/js/auto-complete.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/lunr.min.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/lunr.stemmer.support.min.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/lunr.multi.min.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/lunr.en.min.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/search.js?1726062753 defer></script></div><div id=content-wrapper class=highlightable><ul class=topics><li data-nav-id=/installtion/index.html class=dd-item><a href=https://choria-io.github.io/provisioner/installtion/index.html><b>1. </b>Installation</a></li><li data-nav-id=/configuration/index.html class="dd-item parent"><a href=https://choria-io.github.io/provisioner/configuration/index.html><b>2. </b>Configuration</a><ul id=subsections-632bb56b075027697eb90eb7e3d29a12><li data-nav-id=/configuration/server/index.html class=dd-item><a href=https://choria-io.github.io/provisioner/configuration/server/index.html><b>1.1. </b>Server Setup</a></li><li data-nav-id=/configuration/broker/index.html class="dd-item active"><a href=https://choria-io.github.io/provisioner/configuration/broker/index.html><b>1.2. </b>Broker Setup</a></li><li data-nav-id=/configuration/helper/index.html class=dd-item><a href=https://choria-io.github.io/provisioner/configuration/helper/index.html><b>1.3. </b>Writing a Helper</a></li><li data-nav-id=/configuration/provisioner/index.html class=dd-item><a href=https://choria-io.github.io/provisioner/configuration/provisioner/index.html><b>1.4. </b>Configuration File</a></li></ul></li><li data-nav-id=/managing/index.html class=dd-item><a href=https://choria-io.github.io/provisioner/managing/index.html><b>3. </b>Fleet Management</a></li><li data-nav-id=/monitoring/index.html class=dd-item><a href=https://choria-io.github.io/provisioner/monitoring/index.html><b>4. </b>Monitoring</a></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://github.com/choria-io/provisioner><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a class=padding href=https://github.com/choria-io/provisioner/releases><i class="far fa-save"></i> Download</a></li><li><a class=padding href=https://github.com/choria-io/general/discussions><i class="far fa-comments"></i> Discussions</a></li><li><a class=padding href=https://github.com/choria-io/provisioner/issues><i class="far fa-life-ring"></i> Issues</a></li><li><a class=padding href=https://slack.puppet.com/><i class="fab fa-slack"></i> #choria</a></li></ul></div><div class="footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><hr class="default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding select-container"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=select-clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding select-container"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=choria-relearn value=choria-relearn selected>Choria Relearn</option></select></div><div class=select-clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><button class=padding onclick=clearHistory()><i class="fas fa-history fa-fw"></i> Clear History</button></li></ul></div><div id=footer class="footerFooter showFooter"><style>#footer{font-size:13px;height:100px;margin-left:auto;margin-right:auto;padding:2rem 1rem;text-align:center;min-width:230px;max-width:300px}#footer p{margin:0}</style><p>Hosted at <a href=https://github.com/choria-io>GitHub</a> by <a href=https://www.devco.net/>R.I. Pienaar</a></p></div></div></aside><script src=https://choria-io.github.io/provisioner/js/clipboard.min.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/perfect-scrollbar.min.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/featherlight.min.js?1726062753 defer></script>
<script src=https://choria-io.github.io/provisioner/js/theme.js?1726062753 defer></script></body></html>